{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load comments %}
{% load extra_filters %}

{% block title %}TR-{{ object.pk }}: {{ object.summary }}{% endblock %}
{% block body_class %}cards-pf{% endblock %}

{% block contents %}

<div class="container-cards-pf">
    <!-- Important:  if you need to nest additional .row within a .row.row-cards-pf, do *not* use .row-cards-pf on the nested .row  -->
    <h1 class="col-md-12" style="margin-top: 0">
        <span id="test_run_pk"
            data-pk="{{ object.pk }}"
            data-perm-remove-tag="{{ perms.testruns.delete_testruntag }}"
        >TR-{{ object.pk }}:</span> {{ object.summary }}
    </h1>

    <div class="row row-cards-pf">
        <div class="col-xs-12 col-sm-12 col-md-3">
            <div class="card-pf card-pf-accented card-pf-aggregate-status">

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa pficon-topology"></span>{% trans 'Test plan' %}:
                    <a href="{% url 'test_plan_url_short' object.plan.pk %}">TP-{{ object.plan.pk }}: {{ object.plan.name }}</a>
                </h2>

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa-shopping-cart"></span>{% trans 'Product' %}:
                    <a href="{% url 'testruns-search' %}?product={{ object.product_version.product_id }}" title="Search test runs of {{ object.product_version.product }}">{{ object.product_version.product }}</a>
                </h2>

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa-random"></span>{% trans 'Version' %}:
                    <a href="{% url 'testruns-search' %}?product={{ object.plan.product_id }}&product_version={{ object.plan.product_version_id }}" title="Search test runs of {{ object.plan.product_version.value }}">{{ object.plan.product_version.value }}</a>
                </h2>

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa-wrench"></span>{% trans 'Build' %}:
                    <a href="{% url 'testruns-search' %}?product={{ object.plan.product_id }}&product_version={{ object.plan.product_version_id }}&build={{ object.build_id }}" title="Search test runs of {{ object.build_id }}">{{ object.build }}</a>
                </h2>

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa pficon-user"></span>{% trans 'Manager' %}:
                    <a href="{% url 'tcms-profile' object.manager.username %}">{{ object.manager.username }}</a>
                </h2>

                {% if object.default_tester %}
                    <h2 class="card-pf-title" style="text-align: left">
                        <span class="fa fa-search"></span>{% trans 'Default tester' %}:
                        <a href="{% url 'tcms-profile' object.default_tester.username %}">{{ object.default_tester.username }}</a>
                    </h2>
                {% endif %}

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa-spinner"></span>{% trans 'Status' %}:
                    <input class="bootstrap-switch" id="status_button" type="checkbox"
                        {% if not object.stop_date %}checked{% endif %}
                        {% if not perms.testruns.change_testrun %}disabled{% endif %}>
                </h2>

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa-calendar"></span>{% trans 'Started at' %}:
                    {{ object.start_date }}
                </h2>

                <h2 class="card-pf-title" style="text-align: left">
                    <span class="fa fa-calendar-check-o"></span>{% trans 'Finished at' %}:
                    <span class="stop-date">
                        {% if object.stop_date %}
                            {{ object.stop_date }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </h2>

                <div class="card-pf-body"></div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-3">
            <div class="card-pf card-pf-accented card-pf-aggregate-status">
                <div class="card-pf-body">
                    <div class="progress">
                        <div class="progress-bar progress-completed progress-bar-success progress-bar-striped" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="font-weight: bold;" data-toggle="tooltip"></div>
                        <div class="progress-bar progress-bar-remaining" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="font-weight: bold; color: black;" data-toggle="tooltip"></div>
                        <div class="progress-bar progress-failed progress-bar-danger progress-bar-striped" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="font-weight: bold;" data-toggle="tooltip"></div>
                    </div>
                    <div>
                        <ul class="count-per-status-container list-group" style="columns: 2; margin: 0;">
                            {% for status in execution_statuses%}
                            <li class="list-group-item" style="padding:0; text-align:left">
                                <label>{{ status.name }}</label> - <a id="count-for-status-{{ status.pk }}" href="#"></a>
                            </li>
                            {% endfor %}
                        </ul>

                        <div style="text-align: center">
                            <label>{% trans "TOTAL" %}</label> - <a href="{% url 'testruns-get' object.pk %}" class="total-execution-count"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-6 col-md-3">
            {% include 'include/tags_card.html' with add_perm=perms.testruns.add_testruntag %}
        </div>
    </div> <!-- /row -->

    <div class="row row-cards-pf">
        <div class="col-xs-12 col-sm-12 col-md-12">
            <div class="card-pf card-pf-accented">
                <h2 class="card-pf-title">
                    {% trans 'Test executions' %}
                </h2>
                <div class="container-fluid">
                    <div class="row toolbar-pf">
                        <div class="col-sm-12">
                            <form class="toolbar-pf-actions">
                                <div class="form-group toolbar-pf-filter">
                                    <label class="sr-only" for="filter">Name</label>
                                    <div class="input-group">
                                        <div class="input-group-btn">
                                            <button type="button" class="btn btn-default dropdown-toggle" id="input-filter-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Name <span class="caret"></span></button>
                                            <ul class="dropdown-menu">
                                                <li class="selected"><a href="#">{% trans "Name" %}</a></li>
                                                <li><a href="#">{% trans "Priority" %}</a></li>
                                                <li><a href="#">{% trans "Category" %}</a></li>
                                            </ul>
                                        </div><!-- /input-group-btn -->
                                        <input type="text" class="form-control" id="filter" placeholder='{% trans "Filter By Name..." %}'>
                                    </div><!-- /input-group -->
                                </div>
                                <div class="form-group">
                                    <div class="dropdown btn-group">
                                        <button type="button" class="btn btn-default dropdown-toggle" id="filter-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Name <span class="caret"></span></button>
                                        <ul class="dropdown-menu">
                                            <li class="selected"><a href="#">{% trans "Name" %}</a></li>
                                            <li><a href="#">{% trans "Priority" %}</a></li>
                                            <li><a href="#">Last {% trans "Category" %}</a></li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-link" type="button">
                                        <span class="fa fa-sort-alpha-asc"></span>
                                    </button>
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn btn-default">{% trans "Remove case" %}</button>
                                    <button type="button" class="btn btn-default">{% trans "Update case text" %}</button>
                                    <button type="button" class="btn btn-default">{% trans "Change assignee" %}</button>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-default dropdown-toggle" id="filter-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{% trans "Change status" %} <span class="caret"></span></button>
                                        <ul class="dropdown-menu">
                                            {% for status in execution_statuses %}
                                                <li><a href="#">{{ status.name }}</a></li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-default">{% trans "Add comment" %}</button>
                                    <button type="button" class="btn btn-default">{% trans "Add hyperlink" %}</button>
                                </div>
                            </form>
                            <div class="row toolbar-pf-results">
                                <div class="col-sm-12">
                                    <h5><span class="test-executions-count"></span> Results</h5>
                                    <p>Active filters:</p>
                                    <ul class="list-inline" class="active-filters"></ul>
                                    {% comment %} TODO: maybe don't show this button until at least one filter is added {% endcomment %}
                                    <p><a href="#">Clear All Filters</a></p>
                                </div><!-- /col -->
                            </div><!-- /row -->
                        </div><!-- /col -->
                    </div><!-- /row -->
                </div><!-- /container -->
                <div class="card-pf-body">
                    <div id="test-executions-container" class="list-group tree-list-view-pf">
                        <template id="test-execution-row">
                            <div class="list-group-item">
                                <div class="list-group-item-header">
                                    <div class="list-view-pf-main-info">
                                        <div class="list-view-pf-left">
                                            <span class="fa fa-angle-right"></span>
                                        </div>
                                        <div class="list-view-pf-checkbox" style="margin-top: 0; margin-bottom: 0">
                                            <input type="checkbox">
                                        </div>
                                        <div class="list-view-pf-actions" style="margin-top: 0; margin-bottom: 0;">
                                            <div class="dropdown pull-right dropdown-kebab-pf">
                                                <button class="btn btn-link dropdown-toggle" type="button" id="dropdownKebabRight9"
                                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                    <span class="fa fa-ellipsis-v"></span>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownKebabRight9">
                                                    <li><a href="#" class="add-link-button" data-toggle="modal" data-target="#add-link-modal">{% trans 'Add hyperlink' %}</a></li>
                                                    <li><a href="#" class="one-click-bug-report-button" data-toggle="modal" data-target="#one-click-bug-report-modal">{% trans 'Report bug' %}</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="list-view-pf-body">
                                            <div class="list-view-pf-description" style="flex: 1 0 30%;">
                                                <div class="list-group-item-text">
                                                    <span class="test-execution-info"></span>
                                                    <a class="test-execution-info-link"></a>
                                                 </div>
                                            </div>
                                            <div class="list-view-pf-additional-info">
                                                <div class="list-view-pf-additional-info">
                                                    <div class="list-view-pf-additional-info-item">
                                                        <span class="fa test-execution-automated" data-automated="{% trans 'Automated' %}" data-manual="{% trans 'Manual' %}"></span>
                                                    </div>
                                                    <div title="{% trans 'Priority' %}" class="list-view-pf-additional-info-item">
                                                        <span class="fa fa-hourglass"></span>
                                                        <span class="test-execution-priority"></span>
                                                    </div>
                                                    <div title="{% trans 'Category' %}" class="list-view-pf-additional-info-item">
                                                        <span class="fa fa-tag"></span>
                                                        <span class="test-execution-category"></span>
                                                    </div>
                                                    <div title="{% trans 'Author' %}" class="list-view-pf-additional-info-item">
                                                        <span class="fa pficon-user"></span>
                                                        <span class="test-execution-asignee"></span>
                                                    </div>
                                                    <div title="{% trans 'Default tester' %}" class="list-view-pf-additional-info-item">
                                                        <span class="fa fa-search"></span>
                                                        <span class="test-execution-tester"></span>
                                                    </div>
                                                    <div title="{% trans 'Bugs' %}" class="list-view-pf-additional-info-item">
                                                        <span class="fa fa-bug"></span>
                                                        {% comment %} TODO fetch bugs {% endcomment %}
                                                        <span class="test-execution-bugs-count"></span>
                                                    </div>
                                                </div>
                                                <div class="list-view-pf-additional-info" style="width: 30%;">
                                                    <div title="{% trans 'Status' %}" class="list-view-pf-additional-info-item">
                                                        <i class="fa test-execution-status-icon"></i>
                                                        <strong class="test-execution-status-name"></strong>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="list-group-item-container container-fluid hidden">
                                    <div class="row">
                                        <div class="col-md-9">
                                            <div class="test-execution-text-container markdown-text">
                                                <p class="test-execution-text"></p>
                                                <p class="test-execution-notes">
                                                    <strong>{% trans 'Notes' %}:</strong>
                                                </p>
                                                <strong>{% trans "Bugs and hyperlinks" %}: </strong>
                                                <div>
                                                    <ul class="test-execution-hyperlinks"></ul>
                                                    <template id="link-entry">
                                                        <li><span class="link-icon"></span><a class="link-url" href="${link.url}">${link.name || link.url}</a></li>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <span>{% trans 'Test Case Attachments' %}:</span>
                                            <ul class="list-group list-unstyled test-case-attachments">
                                                <template id="attachments-list-item">
                                                    <li class="list-group-item'">
                                                        <a></a>
                                                    </li>
                                                </template>
                                                <li class="list-group-item hidden">{% trans "No attachments" %}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /row -->

    <div class="row row-cards-pf">
        <div class="col-xs-12 col-sm-6 col-md-6">
            {% include 'include/attachments.html' %}
        </div>
    </div> <!-- /row -->
</div>

<div class="modal fade" id="add-link-modal" tabindex="-1" role="dialog" aria-labelledby="add-hyperlink-modal-title" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="Close">
          <span class="pficon pficon-close"></span>
        </button>
        <h4 class="modal-title" id="add-hyperlink-modal-title">{% trans "Add hyperlink" %}</h4>
      </div>
      <form class="form-horizontal add-hyperlink-form">
        <div class="modal-body">
          <div class="form-group">
            <label class="col-sm-3 control-label" for="{{ link_form.url.id_for_label }}">{% trans "URL" %}</label>
            <div class="col-sm-9">
                <input type="url" name="{{ link_form.url.name }}" maxlength="{{ link_form.url.field.max_length }}" {% if link_form.url.field.required %}required{% endif %} id="{{ link_form.url.id_for_label }}" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="{{ link_form.name.id_for_label }}">{% trans "Name" %}</label>
            <div class="col-sm-9">
                <input type="text" name="{{ link_form.name.name }}" maxlength="{{ link_form.name.field.max_length }}" {% if link_form.name.field.required %}required{% endif %} id="{{ link_form.name.id_for_label }}" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-3 col-lg-3 col-sm-3 control-label" for="defectCheckbox">{% trans "Is a defect" %}</label>
            <div class="col-md-3 col-lg-3 col-sm-3">
                <input class="bootstrap-switch" type="checkbox" id="defectCheckbox" data-on-text="{% trans 'Yes' %}" data-off-text="{% trans 'No' %}"/>
            </div>
          </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans "Cancel" %}</button>
            <button type="submit" class="btn btn-primary add-hyperlink-button">{% trans "Save" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="one-click-bug-report-modal" tabindex="-1" role="dialog" aria-labelledby="one-click-bug-report-title" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="Close">
          <span class="pficon pficon-close"></span>
        </button>
        <h4 class="modal-title" id="one-click-bug-report-title">{% trans "Report bug" %}</h4>
      </div>
      <form class="form-horizontal one-click-bug-report-form">
        <div class="modal-body">
          <div class="form-group">
            <label class="col-sm-3 control-label" for="issue-tracker-select">{% trans "Issue Tracker" %}</label>
            <div class="col-sm-9">
                <select name="issue-tracker" id="id-issue-tracker" class="form-control selectpicker">
                    {% for btr in bug_trackers %}
                        <option value="{{ btr.pk }}">{{ btr.name }}</option>
                    {% endfor %}
                </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans "Cancel" %}</button>
            <button type="submit" class="btn btn-primary one-click-bug-report-button">{% trans "Report Bug" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="{% static 'typeahead.js/dist/typeahead.jquery.min.js' %}"></script>
<script src="{% static 'bootstrap-switch/dist/js/bootstrap-switch.min.js' %}"></script>
<script src="{% static 'bootstrap-select/dist/js/bootstrap-select.min.js' %}"></script>
<script src="{% static 'moment/min/moment.min.js' %}"></script>
<script src="{% static 'moment-timezone/builds/moment-timezone-with-data.min.js' %}"></script>

<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/jsonrpc.js' %}"></script>
<script src="{% static 'js/tags.js' %}"></script>
<script src="{% static 'testruns/js/get.js' %}"></script>
{% endblock %}
